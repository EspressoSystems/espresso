# Many environment variables are shared between services. Such environment variables are set
# globally in the .env file, and merely passed through here.

version: '2'
services:
  # Configure the validators. Each validator exposes 2 ports: the validation port that other
  # validators use to connect to it during consensus, and a port where it hosts a query service.
  # The validation ports are numbered 4000x while the query service ports are numbered 6000x.
  validator0:
    image: ghcr.io/espressosystems/espresso/validator:main
    ports:
      - 40000:40000/tcp
      - 60000:50000/tcp
    environment:
      - ESPRESSO_VALIDATOR_ID=0
      - ESPRESSO_VALIDATOR_NODES
      - ESPRESSO_FAUCET_PUB_KEYS
      - RUST_LOG
    volumes:
      - validator0-store:/store
  validator1:
    image: ghcr.io/espressosystems/espresso/validator:main
    ports:
      - 40001:40001/tcp
      - 60001:50000/tcp
    environment:
      - ESPRESSO_VALIDATOR_ID=1
      - ESPRESSO_VALIDATOR_NODES
      - ESPRESSO_FAUCET_PUB_KEYS
      - RUST_LOG
    volumes:
      - validator1-store:/store
  validator2:
    image: ghcr.io/espressosystems/espresso/validator:main
    ports:
      - 40002:40002/tcp
      - 60002:50000/tcp
    environment:
      - ESPRESSO_VALIDATOR_ID=2
      - ESPRESSO_VALIDATOR_NODES
      - ESPRESSO_FAUCET_PUB_KEYS
      - RUST_LOG
    volumes:
      - validator2-store:/store
  validator3:
    image: ghcr.io/espressosystems/espresso/validator:main
    ports:
      - 40003:40003/tcp
      - 60003:50000/tcp
    environment:
      - ESPRESSO_VALIDATOR_ID=3
      - ESPRESSO_VALIDATOR_NODES
      - ESPRESSO_FAUCET_PUB_KEYS
      - RUST_LOG
    volumes:
      - validator3-store:/store
  validator4:
    image: ghcr.io/espressosystems/espresso/validator:main
    ports:
      - 40004:40004/tcp
      - 60004:50000/tcp
    environment:
      - ESPRESSO_VALIDATOR_ID=4
      - ESPRESSO_VALIDATOR_NODES
      - ESPRESSO_FAUCET_PUB_KEYS
      - RUST_LOG
    volumes:
      - validator4-store:/store
  validator5:
    image: ghcr.io/espressosystems/espresso/validator:main
    ports:
      - 40005:40005/tcp
      - 60005:50000/tcp
    environment:
      - ESPRESSO_VALIDATOR_ID=5
      - ESPRESSO_VALIDATOR_NODES
      - ESPRESSO_FAUCET_PUB_KEYS
      - RUST_LOG
    volumes:
      - validator5-store:/store
  validator6:
    image: ghcr.io/espressosystems/espresso/validator:main
    ports:
      - 40006:40006/tcp
      - 60006:50000/tcp
    environment:
      - ESPRESSO_VALIDATOR_ID=6
      - ESPRESSO_VALIDATOR_NODES
      - ESPRESSO_FAUCET_PUB_KEYS
      - RUST_LOG
    volumes:
      - validator6-store:/store

  # Configure services. Services run at ports starting at 50000.
  faucet:
    image: ghcr.io/espressosystems/espresso/faucet:main
    command: wait-for-it validator0:$ESPRESSO_VALIDATOR_PORT -- wait-for-it address-book:$ESPRESSO_ADDRESS_BOOK_PORT -- faucet
    ports:
      - $ESPRESSO_FAUCET_PORT:$ESPRESSO_FAUCET_PORT/tcp
    environment:
      - ESPRESSO_FAUCET_PORT
      - ESPRESSO_FAUCET_WALLET_MNEMONIC
      - ESPRESSO_SUBMIT_URL
      - ESPRESSO_ESQS_URL
      - ESPRESSO_ADDRESS_BOOK_URL
      - RUST_LOG
    volumes:
      - faucet-store:/store
  address-book:
    image: ghcr.io/espressosystems/espresso/address-book:main
    ports:
      - $ESPRESSO_ADDRESS_BOOK_PORT:$ESPRESSO_ADDRESS_BOOK_PORT/tcp
    environment:
      - ESPRESSO_ADDRESS_BOOK_PORT
      - RUST_LOG
    volumes:
      - address-book-store:/store

  Configure random wallet
  random-wallet:
    image: ghcr.io/espressosystems/espresso/random-wallet:main
    command: wait-for-it validator0:$ESPRESSO_VALIDATOR_PORT -- wait-for-it address-book:$ESPRESSO_ADDRESS_BOOK_PORT -- random-wallet
    environment:
      - ESPRESSO_FAUCET_URL
      - ESPRESSO_SUBMIT_URL
      - ESPRESSO_ESQS_URL
      - ESPRESSO_ADDRESS_BOOK_URL
      - RUST_LOG
    volumes:
      - random-wallet-store:/store

volumes:
  validator0-store:
  validator1-store:
  validator2-store:
  validator3-store:
  validator4-store:
  validator5-store:
  validator6-store:
  faucet-store:
  address-book-store:
  random-wallet-store:
